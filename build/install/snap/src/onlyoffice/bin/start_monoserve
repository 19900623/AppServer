#!/bin/bash

set -x

# shellcheck source=src/mysql/utilities/mysql-utilities
. "$SNAP/utilities/mysql-utilities"

# shellcheck source=src/onlyoffice/utilities/monoserve-utilities
. "${SNAP}/utilities/monoserve-utilities"

# shellcheck source=src/redis/utilities/redis-utilities
. "$SNAP/utilities/redis-utilities"


wait_for_redis
wait_for_mysql

DB_NAME="onlyoffice";
DB_HOST="localhost";
DB_USER="onlyoffice";
DB_PWD=$( mysql_get_onlyoffice_password );


ONLYOFFICE_CORE_MACHINEKEY=$( onlyoffice_get_core_machine_key );

cp -drf ${SNAP}/config/hyperfastcgi-config/* ${SNAP_DATA}/hyperfastcgi/

[ -e ${ONLYOFFCE_SOCKET} ] && rm -f ${ONLYOFFCE_SOCKET}

sed -e "s|\${SNAP}|$SNAP|;s|\${SNAP_DATA}|$SNAP_DATA|;s|\${ONLYOFFICE_SOCKET}|$ONLYOFFICE_SOCKET|" -i ${SNAP_DATA}/hyperfastcgi/onlyoffice

mkdir -p  ${SNAP_DATA}/onlyoffice/config/WebStudio/
cp -dfr ${SNAP}/var/www/onlyoffice/WebStudio/*.config ${SNAP_DATA}/onlyoffice/config/WebStudio/

sed "/core.machinekey/s!value=\".*\"!value=\"${ONLYOFFICE_CORE_MACHINEKEY}\"!g" -i  ${SNAP_DATA}/onlyoffice/config/WebStudio/web.appsettings.config
sed "s!/var/log/onlyoffice/!${SNAP_DATA}/onlyoffice/logs/!g" -i ${SNAP_DATA}/onlyoffice/config/WebStudio/web.log4net.config
sed "s|\.*\\\Data\\\|${SNAP_DATA}/onlyoffice/data/|g" -i ${SNAP_DATA}/onlyoffice/config/WebStudio/web.storage.config

sed "s|Password=.*;|Password=${DB_PWD};|g" -i ${SNAP_DATA}/onlyoffice/config/WebStudio/web.connections.config
sed "s|User\\s*ID=.*;|User\\s*ID=${DB_USER};|g" -i ${SNAP_DATA}/onlyoffice/config/WebStudio/web.connections.config


export ONLYOFFICE_APP_CONFIG_FILE="${SNAP_DATA}/onlyoffice/config/WebStudio/Web.config";

MYSQL="mysql -h$DB_HOST -u$DB_USER -p$DB_PWD -S$MYSQL_SOCKET";

DB_TABLES_COUNT=$($MYSQL --silent --skip-column-names -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='${DB_NAME}'");

if [ "${DB_TABLES_COUNT}" -eq "0" ]; then

	$MYSQL "$DB_NAME" < $SNAP/var/www/onlyoffice/Sql/onlyoffice.sql
	$MYSQL "$DB_NAME" < $SNAP/var/www/onlyoffice/Sql/onlyoffice.data.sql
	$MYSQL "$DB_NAME" < $SNAP/var/www/onlyoffice/Sql/onlyoffice.resources.sql
fi

for i in $(ls $SNAP/var/www/onlyoffice/Sql/onlyoffice.upgrade*); do
	$MYSQL "$DB_NAME" < ${i};
done

# export mono variables
export MONO_IOMAP=all
export MONO_ASPNET_WEBCONFIG_CACHESIZE=2000
export MONO_THREADS_PER_CPU=2000
export MONO_OPTIONS="--server"
export MONO_GC_PARAMS=nursery-size=64m

PKG_DIR=$SNAP/usr

export MONO_PATH=$PKG_DIR/lib/mono/4.5
export MONO_CONFIG=$SNAP/etc/mono/config
export MONO_CFG_DIR=$SNAP/etc
export C_INCLUDE_PATH=${PKG_DIR}/include
export MONO_REGISTRY_PATH=~/.mono/registry
export MONO_GAC_PREFIX=$PKG_DIR/lib/mono/gac/
#export LD_LIBRARY_PATH=$PKG_DIR/lib:$LD_LIBRARY_PATH

export LD_RUN_PATH=$LD_LIBRARY_PATH
#export LD_DEBUG=files

export PKG_CONFIG_PATH=$PKG_DIR/lib/pkgconfig:$PKG_CONFIG_PATH
export ACLOCAL_PATH=${PKG_DIR}/share/aclocal
#export MONO_LOG_LEVEL=debug
#export FONTCONFIG_PATH=${PKG_DIR}/etc/fonts
#export XDG_DATA_HOME=${PKG_DIR}/etc/fonts


exec ${SNAP}/usr/bin/mono ${SNAP}/usr/lib/hyperfastcgi/4.0/HyperFastCgi.exe /config=${SNAP_DATA}/hyperfastcgi/onlyoffice /logfile=${SNAP_DATA}/onlyoffice/logs/onlyoffice.log
