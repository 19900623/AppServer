location / {
        root    ${SNAP}/var/www/onlyoffice/WebStudio/;
        index   index.html index.htm default.aspx Default.aspx;

        client_max_body_size    4G;

        fastcgi_pass fastcgi_backend;
        fastcgi_keep_conn on;
        
        error_page 404 /404.htm;

        gzip             off;
        gzip_comp_level  2;
        gzip_min_length  1000;
        gzip_proxied     expired no-cache no-store private auth;
        gzip_types       text/html application/x-javascript text/css application/xml;

        fastcgi_index   Default.aspx;
        fastcgi_intercept_errors on;

        include ${SNAP}/conf/fastcgi_params;

        fastcgi_param HTTP_X_REWRITER_URL $X_REWRITER_URL;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO "";

        fastcgi_read_timeout    600;
        fastcgi_send_timeout    600;

        location ~* (^\/(?:skins|products|addons).*\.(?:jpg|jpeg|gif|png|svg|ico)$)|(.*bundle/(?!clientscript).*) {
                fastcgi_pass fastcgi_backend;

                fastcgi_temp_path        ${SNAP_DATA}/nginx/cache/tmp 1 2;
                fastcgi_cache            onlyoffice;
                fastcgi_cache_key        "$scheme|$request_method|$host|$request_uri|$query_string";
                fastcgi_cache_use_stale  updating error timeout invalid_header http_500;
                fastcgi_cache_valid      1d;
                fastcgi_ignore_headers   Cache-Control Expires Set-Cookie;

                add_header X-Fastcgi-Cache $upstream_cache_status;
                access_log off;
                log_not_found off;
                expires max;
        }

}

location /apisystem {
	rewrite /apisystem(.*) /$1  break;

        root    ${SNAP}/var/www/onlyoffice/ApiSystem/;
        index    index.html index.htm default.aspx Default.aspx;

        add_header    Access-Control-Allow-Origin *;
        add_header    X-Frame-Options DENY;

        client_max_body_size    4G;

        fastcgi_keep_conn on;
        fastcgi_pass fastcgi_backend_apisystem;

        include ${SNAP}/conf/fastcgi_params;

        set $X_REWRITER_URL $scheme://$http_host;

        if ($http_x_rewriter_url != '') {
          set $X_REWRITER_URL $http_x_rewriter_url ;
        }


        fastcgi_param   HTTP_X_REWRITER_URL $X_REWRITER_URL;
        fastcgi_param   SCRIPT_FILENAME                 $document_root$fastcgi_script_name;
        fastcgi_param   PATH_INFO                       "";

        fastcgi_read_timeout    600;
        fastcgi_send_timeout    600;
}

location /filesData {
        rewrite /filesData/var/www/onlyoffice/Data/Products/Files(.*) /$1  break;
        root    ${SNAP_DATA}/onlyoffice/Data/Products/Files;
        internal;
}
